@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script src="~/Scripts/underscore.js"></script>
    <script src="~/Scripts/jquery-1.9.1.js"></script>
    <script src="~/Scripts/backbone.js"></script>
    <script src="~/Scripts/bootstrap.js"></script>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <script type="text/javascript">
        var App = {
            Models: {},
            Collections: {},
            Views: {},
            start: function () {
                App.router = new App.Router();
                Backbone.history.start();
                
            }
        }




        App.Models.Anunciante = Backbone.Model.extend({ idAttribute: 'IdAnunciante' });

        App.Collections.Anunciantes = Backbone.Collection.extend({
            model: App.Models.Anunciante,
            url: '/api/anunciante'
            
        });


        //View Anunciante
        App.Views.Anunciante = Backbone.View.extend({
            initialize:function(){
                this.listenTo(this.model, "change", this.render, this);
            },
            tagName: "tr",
            className: "anunciante",
            template: _.template("<td><%=Nome%></td><td><a href='mailto:<%=Email%>'><%=Email%></a></td><td></span class='telefone'><%=Telefone%></span></td>"),
            render: function () {
                this.$el.html(this.template(this.model.toJSON()));
                return this.$el;
            }
        });
        //View coleção de Anunciante
        App.Views.Anunciantes = Backbone.View.extend({
            
            initialize: function () {
                this.listenTo(this.collection, "add", this.adicionAnunciante, this);
                this.listenTo(this.collection, "reset", this.render, this);
                this.listenTo(this.collection, "sort", this.render, this);
            },
            tagName: "table",
            className: "table table-condensed",
            
            adicionAnunciante: function (anunciante) {
                console.log('um');
                anuncianteView = new App.Views.Anunciante({ model: anunciante });
                this.$el.append(anuncianteView.render());
            },
         
            
            adicionaTodos: function (data)
            {
                console.log('todos');
                data.forEach(this.adicionAnunciante, this);
            },
            render: function (data) {
                if (data) {
                    this.collection = data;
                }
               
                this.$el.empty();
               
                this.adicionaTodos(this.collection);
                return this.$el;
            }
            
        });

        App.Views.FormAnunciante = Backbone.View.extend({
            Template: _.template('<form> <fieldset><legend>Cadastro de novo Anunciante</legend>' +
                '<label for="Nome">Nome:</label><input type="text"  id="Nome" name=Nome value="" />' +
                '<label for="Email">Email:</label><input type="text" id=Email name=Email value="" />' +
                '<label for="Telefone">Telefone:</label><input type="text"  id=Telefone  name=Telefone value="" /><br />' +
                '<button type="submit" class="btn">Submit</button></fieldset></form>'),
            events: {
                submit:"insereAnunciante"
            },
            insereAnunciante: function (e) {
                e.preventDefault();
                var Nome = this.$("#Nome").val();
                var Email = this.$("#Email").val();
                var Telefone = this.$("#Telefone").val();
                this.collection.create({ Nome: Nome, Email: Email, Telefone: Telefone });
                $("input").val('');
            },
            render: function () {
                this.$el.html(this.Template());
                return this.$el;
            },
            exibir: function () {
                $("#form").show();
            },
            esconder: function () {
                $("#form").hide();
            }
        });

   


        App.Router = Backbone.Router.extend({
            routes: {
                "":"index",
                "temanuncio": "temAnuncio",
                "sortBy/:field": "sortBy",
                "todos": "todos",
                "cadastro":"cadastro"
            },
            cadastro: function () {
                App.Views.formAnunciante.exibir();
            },
            todos:function(todos){
                this.sortBy("Nome");
                App.Views.formAnunciante.esconder();
            },
            sortBy:function(field){
                App.Collections.anunciantes.comparator = function (model) {
                    return model.get(field);
                }
                App.Collections.anunciantes.sort();
            },
            temAnuncio: function () {
                var anunciantesQueTemAnuncio = App.Collections.anunciantes.filter(
                    function (x) {
                        if (x.get("Anuncios").length > 0)
                            return x;
                    });
                App.Views.anunciantes.render(anunciantesQueTemAnuncio);

            },
            index: function () {
                
                App.Collections.anunciantes = new App.Collections.Anunciantes();
                App.Views.anunciantes = new App.Views.Anunciantes({ el: "#anunciantes", collection: App.Collections.anunciantes });
                App.Collections.anunciantes.fetch();
                App.Views.formAnunciante = new App.Views.FormAnunciante({ el: "#form", collection: App.Collections.anunciantes });
                App.Views.formAnunciante.render();
                App.Views.formAnunciante.esconder();
            }

        });



        $(function () {
            App.start();
        })
    </script>
    <style>
        #form{display:none;
        }
        nav.well {
        max-width:170px;
        }
    </style>
</head>
<body>
    <div class="row-fluid">
        <div class="span12">
            <nav class="navbar">
                <div class="navbar-inner">
                    <a class="brand" href="/anunciospa">MVP Conference</a>
                    <ul class="nav">
                         <li><a href="#todos">Todos</a></li>
                        <li><a href="#temanuncio">Quem tem Anuncio</a></li>
                        <li><a href="#sortBy/Nome">Ordenar por Nome</a></li>
                          <li><a href="#sortBy/Telefone">Ordenar por Telefone</a></li>
                          <li><a href="#sortBy/Email">Ordenar por Email</a></li>
                        <li><a href="#cadastro">Cadastro</a></li>

                    </ul>
                </div>
            </nav>
            
            <div id="divanunciantes" class="span6">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                        </tr>
                    </thead>
                    <tbody id="anunciantes">

                    </tbody>
                </table>
            </div>
            <div id="form" class="span5"></div>

        </div>
    
    </div>
    
    
</body>
</html>
