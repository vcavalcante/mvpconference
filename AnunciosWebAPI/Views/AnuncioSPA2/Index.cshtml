@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>MVP Conference</title>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script src="~/Scripts/jquery-1.9.1.js"></script>
    <script src="~/Scripts/underscore.js"></script>
    <script src="~/Scripts/backbone.js"></script>
    <script type="text/javascript">
        ////anunciante 1
        //var Model = Backbone.Model.extend({
        //    urlRoot: "/api/anunciante",
        //    idAttribute: 'IdAnunciante'
        //});
        //var model = new Model({ IdAnunciante: 3 });
        //model.fetch();

        ////salvar novo anunciante
        //var model = new Model({
        //    Nome: "Victor Cavalcante",
        //    Email: "vcavalcante@lambda3.com.br",
        //    Telefone: "11-2386-1886"
        //});
        //model.save();

        ////definindo o default
        //var Model = Backbone.Model.extend({
        //    urlRoot: "/api/anunciante",
        //    idAttribute: 'IdAnunciante',
        //    defaults: { Nome: 'João ninguem' }
        //});
        //var model = new Model({ "Email": "vcavalcante@lambda3.com.br" });
        //model.get("Nome");

        ////Collection 
        //var ModelAnunciante =Backbone.Model.extend({idAttribute: 'IdAnunciante'});
        //var CollectionAnunciante = Backbone.Collection.extend({
        //    url: "/api/anunciante",
        //    model: ModelAnunciante
        //});
        //var collectionAnunciante = new CollectionAnunciante();
        //collectionAnunciante.fetch();
        //collectionAnunciante.length;
        //collectionAnunciante.toJSON();

        ////selecionando collections
        //collectionAnunciante.where({ Nome: 'Renato' });
        //collectionAnunciante.filter(function (x) {
        //    if (x.get("Nome").indexOf("R") == 0) return x;
        //});
        var App = {
            Models: {},
            Collections: {},
            Views: {},
            start: function () {
                App.router = new App.Router();
                Backbone.history.start();
            }
           
        }
       
        //View Anunciante 
        //Definindo o modelo
        App.Models.Anunciante = Backbone.Model.extend({});
        App.Models.anunciante =  new App.Models.Anunciante({
            Nome: "Victor",
            Email: "victor@cavalcante.net",
            Telefone: '11-29292929'
        });
        //definindo a View
        App.Views.Anunciante = Backbone.View.extend({
            tagName: "tr",
            template: _.template("<td><%=Nome%></td>" +
                "<td><a href='mailto:<%=Email%>'><%=Email%></a></td>" +
                "<td></span class='telefone'><%=Telefone%></span></td>"),
            render: function () {
                this.$el.html(this.template(this.model.toJSON()));
                return this.$el;
            }
        });
        //instanciando a view
        App.Views.anunciante = new App.Views.Anunciante({
            model: App.Models.anunciante
        })
        //renderizando a view
        $("#anunciantes").append(App.Views.anunciante.render());

        //fazendo na mão
        App.Views.anunciante = new App.Views.Anunciante({
            model: new App.Models.Anunciante({ Nome: "Igor Abade", Email: "igor@lambda3.com.br", Telefone: "11-20202020202" })
        });
        $("#anunciantes").append(App.Views.anunciante.render());

        //criando a coleção
        App.Collections.Anunciantes = Backbone.Collection.extend({
            url: "/api/anunciante",
            model: App.Models.Anunciante,
            comparator: "Nome"
        });
        App.Collections.anunciantes = new App.Collections.Anunciantes();
        App.Collections.anunciantes.fetch();

        //criando a view da collection

        App.Views.Anunciantes = Backbone.View.extend({
            initialize: function () {
                this.listenTo(this.collection, "add", this.adicionAnunciante, this);
                this.listenTo(this.collection, "reset", this.render, this);
                this.listenTo(this.collection, "sort", this.render, this);
            },
            addAnunciante: function (anunciante) {
                anuncianteView = new App.Views.Anunciante({ model: anunciante });
                this.$el.append(anuncianteView.render());
            },
            //render collection
            render: function (data) {
                if (data) {
                    this.collection = data;
                }
                this.$el.empty();
                this.collection.forEach(this.addAnunciante, this);
                return this.$el;
            }
        });
        //form view
        App.Views.FormAnunciante = Backbone.View.extend({
            Template: _.template('<form> <fieldset><legend>Cadastro de novo Anunciante</legend>' +
                '<label for="Nome">Nome:</label><input type="text"  id="Nome" name=Nome value="" />' +
                '<label for="Email">Email:</label><input type="text" id=Email name=Email value="" />' +
                '<label for="Telefone">Telefone:</label><input type="text"  id=Telefone  name=Telefone value="" /><br />' +
                '<button type="submit" class="btn">Submit</button></fieldset></form>'),
            events: {
                submit: "insereAnunciante"
            },
            insereAnunciante: function (e) {
                e.preventDefault();
                var Nome = this.$("#Nome").val();
                var Email = this.$("#Email").val();
                var Telefone = this.$("#Telefone").val();
                this.collection.create({ Nome: Nome, Email: Email, Telefone: Telefone });
                $("input").val('');
            },
            render: function () {
                this.$el.html(this.Template());
                return this.$el;
            },
            exibir: function () {
                $("#form").show();
            },
            esconder: function () {
                $("#form").hide();
            }
        });

        App.Router = Backbone.Router.extend({
            routes: {
                "": "index",
                "cadastro": "cadastro",
                "todos": "todos",
                "temanuncio": "temAnuncio",
                "sortBy/:field": "sortBy"

            },
            todos: function (todos) {
                this.sortBy("Nome");
                App.Views.formAnunciante.esconder();
            },
            sortBy: function (field) {
                App.Collections.anunciantes.comparator = function (model) {
                    return model.get(field);
                }
                App.Collections.anunciantes.sort();
            },
            temAnuncio: function () {
                var anunciantesQueTemAnuncio = App.Collections.anunciantes.filter(
                    function (x) {
                        if (x.get("Anuncios").length > 0)
                            return x;
                    });
                App.Views.anunciantes.render(anunciantesQueTemAnuncio);

            },
            
            cadastro: function () {
                App.Views.formAnunciante.exibir();
            },
            index: function () {
                App.Collections.anunciantes = new App.Collections.Anunciantes();
                App.Views.anunciantes = new App.Views.Anunciantes({ el: "#anunciantes", collection: App.Collections.anunciantes });
                App.Collections.anunciantes.fetch();
                App.Views.formAnunciante = new App.Views.FormAnunciante({ el: "#form", collection: App.Collections.anunciantes });
                App.Views.formAnunciante.render();
                App.Views.formAnunciante.esconder();
            }
        });


        //instanciando a view
        $(function () {
            App.start();
        });

     
    </script>
    <style>
        #form {
            display:none;
        }
    </style>
</head>
<body>
    <!--Html Inicial-->
    <div class="row-fluid">
        <div class="span12">
            
            <!--menu-->
            <nav class="navbar">
                <div class="navbar-inner">
                    <a class="brand" href="/anunciospa2">MVP Conference</a>
                    <ul class="nav">
                        <li><a href="#todos">Todos</a></li>
                        <li><a href="#temanuncio">Quem tem Anuncio</a></li>
                        <li><a href="#sortBy/Nome">Ordenar por Nome</a></li>
                        <li><a href="#sortBy/Telefone">Ordenar por Telefone</a></li>
                        <li><a href="#sortBy/Email">Ordenar por Email</a></li>
                        <li><a href="#cadastro">Cadastro</a></li>

                    </ul>
                </div>
            </nav>
            <!--Table-->
            <div id="divanunciantes" class="span6">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefone</th>
                        </tr>
                    </thead>
                    <tbody id="anunciantes">
                    </tbody>
                </table>
            </div>
            <div id="form" class="span5"></div>

        </div>

    </div>
</body>
</html>
